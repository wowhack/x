<!DOCTYPE>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="top"></div>
    <div id="boardcontent">

    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js"></script>
   
    <script>
      hljs.initHighlightingOnLoad();

      var zindexCounter = 0;

      $(function() {
        $.get('/board', function (board) {
          console.log('loading board with id: ' + board.boardId);
          //first iterate to set highest zindex
          for (var i = 0; i < board.items.length; i += 1) {
            var item = board.items[i];
            if (typeof item.zindex !== 'undefined') {
              var zindex = parseInt(item.zindex, 10);
              if (zindex > zindexCounter) {
                zindexCounter = zindex;
                console.log(zindexCounter);
              }
            }
          }
          for (var i = 0; i < board.items.length; i += 1) {
            var item = board.items[i];
            addItem(item);
          }
        });

        var host = location.origin.replace(/^http/, 'ws');
        var ws = new WebSocket(host);
        ws.onmessage = function (event) {
          addItem(JSON.parse(event.data));
        };
      });

      var addItem = function(item) {
        if (item.type === 'IMAGE') {
          addDraggableAndResizable(item);
        }
        if (item.type === 'YOUTUBE') {
          addDraggable(item);
        }
        if (item.type === 'SPOTIFY') {
          addDraggable(item);
        }
        if (item.type === 'TEXT') {
          addDraggable(item);
        }
        if (item.type === 'CODE') {
          addDraggable(item);
        }
      };

      var addDraggableAndResizable = function(item) {
        var div = getDiv(item);
        div.appendTo('#boardcontent');
        updateDraggable(div);
        updateResizable(div);
        var position;
        if (typeof item.position !== 'undefined') {
          position = item.position;
        } else {
          position = getRandomPositionInBoard(div);
        }
        var zindex;
        if (typeof item.zindex !== 'undefined') {
          zindex = item.zindex;
        } else {
          zindex = getAndIncrementZindex();
        }
        setPosition(div, position, zindex);
        if (typeof item.size !== 'undefined') {
          setSize(div, item.size);
        }
      };

      var addDraggable = function (item) {
        var div = getDiv(item);
        div.appendTo('#boardcontent');
        updateDraggable(div);
        var position;
        if (typeof item.position !== 'undefined') {
          position = item.position;
        } else {
          position = getRandomPositionInBoard(div);
        }
        var zindex;
        if (typeof item.zindex !== 'undefined') {
          zindex = item.zindex;
        } else {
          zindex = getAndIncrementZindex();
        }
        setPosition(div, position, zindex);
      };

      var getDiv = function (item) {
        var div;
        if (item.type === 'IMAGE') {
          div = $('<div id="' + item.id + '" class="polaroid draggable imgcontainer" style="position: absolute"><span class="pin"></span><img src="' + item.url + '"></div>');
        } else if (item.type === 'YOUTUBE') {
          div = $('<div id="' + item.id + '" class="polaroid frame movie draggable" style="width: 400px; height:300px; position: absolute"><span class="pin"></span><iframe width="400" height="300" src="//www.youtube.com/embed/' + item.videoId + '" frameborder="0" allowfullscreen></iframe></div>');
        } else if (item.type === 'SPOTIFY') {
          div = $('<div id="' + item.id + '" class="polaroid frame track draggable" style="position: absolute"><span class="pin"></span><iframe src="https://embed.spotify.com/?uri=' + item.uri + '" width="300" height="380" frameborder="0" allowtransparency="true"></iframe></div>');
        } else if (item.type === 'TEXT') {
          div = $('<div id="' + item.id + '" class="quote draggable" style="width: 400px; position: absolute"><span class="pin"></span><p>'+ item.content +'</p></div>');
        } else if (item.type === 'CODE') {
          var codeLang = js;
          if (typeof item.codeLang !== 'undefined') {
            codeLang = item.codeLang;
          }
          div = $('<div id="' + item.id + '" class="code draggable" style="width: 400px; position: absolute"><span class="pin"></span><pre><code class="' + codeLang + '">'+ item.content +'</code></pre></div>');
        }
        return div;
      };

      var getAndIncrementZindex = function() {
        zindexCounter += 1;
        return zindexCounter;
      };

      var updateDraggable = function(draggableDiv) {
        var zindexCount = getAndIncrementZindex();
        draggableDiv.css('z-index', zindexCount)
        draggableDiv.draggable({
          containment: "parent",
          start: function(){
            $(this).css('z-index', getAndIncrementZindex());
            $(this).children('.pin').hide();
          },
          stop: function(){
            $(this).children('.pin').show();
            sendPosition($(this));
          }
        });
//        draggableDiv.click(function(){
//          $(this).css('z-index', getAndIncrementZindex());
//        });
      };

      var setPosition = function(div, position, zindex) {
        div.offset(position);
        div.css({top: position.top+'px', left: position.left+'px' });
        div.zIndex(zindex);
      };

      var sendPosition = function(div) {
        var offset = div.offset();
        var left = Math.round(offset.left);
        var top = Math.round(offset.top);
        var itemId = div.attr('id');
        var zindex = parseInt(div.zIndex(), 10);
        console.log('zindex of ' + itemId + ': ' + zindex);
        var obj = {
          position: {
            left: left,
            top: top
          },
          zindex: zindex
        }
        $.post('/item/' + itemId + '/position', obj);
      };

      var updateResizable = function(resizableDiv) {
        resizableDiv.resizable({
          aspectRatio: true,
          stop: function() {
            sendSize($(this));
          }
        });
      };

      var setSize = function(div, size) {
        div.height(size.height);
        div.width(size.width);
      };

      var sendSize = function(div) {
        var width = div.width();
        var height = div.height();
        var size = {width: width, height: height};
        var itemId = div.attr('id');
        $.post('/item/' + itemId + '/size', size);
      };

      var getRandomPositionInBoard = function(div) {
        var width = Math.round(div.width());
        var height = Math.round(div.height());
        var bcWidth = Math.round($('#boardcontent').width());
        var bcHeight = Math.round($('#boardcontent').height());
        var posLeft = Math.floor(Math.random() * ((bcWidth - width) - 0 + 1));
        var posTop = Math.floor(Math.random() * ((bcHeight - height) - 0 + 1));
        return {
          left: posLeft,
          top: posTop
        }
      };

    </script>
  </body>
</html>