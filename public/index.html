<!DOCTYPE>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="top"></div>
    <div id="boardcontent"></div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>
   
    <script>

      var zindexCounter = 5;

      $(function() {
        $.get('/board', function (board) {
          console.log('loading board with id: ' + board.boardId);
          for (var i = 0; i < board.items.length; i += 1) {
            var item = board.items[i];
            addItem(item);
          }
        });

        var host = location.origin.replace(/^http/, 'ws')
        var ws = new WebSocket(host);
        ws.onmessage = function (event) {
          addItem(JSON.parse(event.data));
        };
      });

      var addItem = function(item) {
        console.log(item.type);
        if (item.type === 'IMAGE') {
          addImage(item);
        }
        if (item.type === 'YOUTUBE') {
          addYoutube(item);
        }
        if (item.type === 'SPOTIFY') {
          addSpotify(item);
        }
        if (item.type === 'TEXT') {
          addText(item);
        }
      };

      var addImage = function(imageItem) {
        var imageDiv = $('<div class="polaroid draggable imgcontainer"><span class="pin"></span><img src="' + imageItem.url + '"></div>');
        imageDiv.appendTo('#boardcontent');
        updateDraggable(imageDiv);
        updateResizable(imageDiv);
      };

      var addYoutube = function(youtubeItem) {
        var youtubeDiv = $('<div class="polaroid frame movie draggable" style="width: 400px; height:300px;"><span class="pin"></span><iframe width="400" height="300" src="//www.youtube.com/embed/' + youtubeItem.videoId + '" frameborder="0" allowfullscreen></iframe></div>');
        youtubeDiv.appendTo('#boardcontent');
        updateDraggable(youtubeDiv);
      };

      var addSpotify = function(spotifyItem) {
        var spotifyDiv = $('<div class="polaroid frame track draggable"><span class="pin"></span><iframe src="https://embed.spotify.com/?uri=' + spotifyItem.uri + '" width="300" height="380" frameborder="0" allowtransparency="true"></iframe></div>');
        spotifyDiv.appendTo('#boardcontent');
        updateDraggable(spotifyDiv);
      };

      var addText = function(textItem) {
        //textItem.content has the text...
        var textDiv = $('<div class="quote draggable" style="width: 400px;"><span class="pin"></span><p>'+ textItem.content +'</p></div>');
        textDiv.appendTo('#boardcontent');
        updateDraggable(textDiv);
      };

      var getAndIncrementZindex = function() {
        zindexCounter += 1;
        return zindexCounter;
      };

      var updateDraggable = function(draggableDiv) {
        var zindexCount = getAndIncrementZindex();
        draggableDiv.css('z-index', zindexCount)
        draggableDiv.draggable({
          containment: "parent",
          start: function(){
            $(this).css('z-index', getAndIncrementZindex());
            $(this).children('.pin').hide();
          },
          stop: function(){
            $(this).children('.pin').show();
          }
        });
        draggableDiv.click(function(){
          $(this).css('z-index', getAndIncrementZindex());
        });
      };

      var updateResizable = function(resizableDiv) {
        resizableDiv.resizable({aspectRatio: true});
      };

    </script>
  </body>
</html>